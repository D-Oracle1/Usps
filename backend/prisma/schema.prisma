// Courier Tracking System - Prisma Schema
// Real-time shipment tracking with admin controls

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Admin User Model
model AdminUser {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(ADMIN)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  trackingEvents        TrackingEvent[]
  pausedShipments       ShipmentMovementState[] @relation("PausedBy")
  addressChangeFees     AddressChangeFee[]
  assignedConversations Conversation[]

  @@map("admin_users")
}

// Support User Model - Customer accounts for chat
model SupportUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  phone         String?
  isOnline      Boolean   @default(false) @map("is_online")
  lastSeenAt    DateTime? @map("last_seen_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  conversations Conversation[]

  @@map("support_users")
}

// Conversation Model - Chat threads
model Conversation {
  id              String               @id @default(uuid())
  supportUserId   String               @map("support_user_id")
  trackingNumber  String?              @map("tracking_number")
  subject         String?
  status          ConversationStatus   @default(OPEN)
  priority        ConversationPriority @default(NORMAL)
  assignedAdminId String?              @map("assigned_admin_id")
  lastMessageAt   DateTime?            @map("last_message_at")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  supportUser   SupportUser @relation(fields: [supportUserId], references: [id], onDelete: Cascade)
  assignedAdmin AdminUser?  @relation(fields: [assignedAdminId], references: [id], onDelete: SetNull)
  messages      Message[]

  @@index([supportUserId])
  @@index([trackingNumber])
  @@index([status])
  @@map("conversations")
}

// Message Model - Individual chat messages
model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  senderType     SenderType  @map("sender_type")
  content        String
  messageType    MessageType @default(TEXT) @map("message_type")
  isRead         Boolean     @default(false) @map("is_read")
  readAt         DateTime?   @map("read_at")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  // Note: senderId can be either SupportUser.id or AdminUser.id depending on senderType
  // No foreign key constraint to allow both user types

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// Shipment Model - Core entity
model Shipment {
  id                  String   @id @default(uuid())
  trackingNumber      String   @unique @map("tracking_number")
  originLocation      String   @map("origin_location")
  destinationLocation String   @map("destination_location")
  currentStatus       ShipmentStatus @default(PENDING) @map("current_status")
  currentLocation     String?  @map("current_location")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Package details
  goodsDescription    String?  @map("goods_description")
  packageWeight       Float?   @map("package_weight")
  packageDimensions   String?  @map("package_dimensions")
  declaredValue       Float?   @map("declared_value")
  serviceType         String?  @map("service_type")

  // Sender info
  senderName          String?  @map("sender_name")
  senderPhone         String?  @map("sender_phone")
  senderEmail         String?  @map("sender_email")

  // Recipient info
  recipientName       String?  @map("recipient_name")
  recipientPhone      String?  @map("recipient_phone")
  recipientEmail      String?  @map("recipient_email")

  // Special instructions
  specialInstructions String?  @map("special_instructions")

  // Distance and ETA tracking
  totalDistance       Float?   @map("total_distance")
  remainingDistance   Float?   @map("remaining_distance")
  estimatedArrival    DateTime? @map("estimated_arrival")
  tripStartedAt       DateTime? @map("trip_started_at")
  averageSpeed        Float?   @default(45) @map("average_speed")

  // Relations
  trackingEvents      TrackingEvent[]
  locations           ShipmentLocation[]
  movementState       ShipmentMovementState?
  addressChangeFees   AddressChangeFee[]

  @@index([trackingNumber])
  @@map("shipments")
}

// Tracking Event Model - Permanent event timeline
model TrackingEvent {
  id          String   @id @default(uuid())
  shipmentId  String   @map("shipment_id")
  status      String
  description String
  location    String
  eventTime   DateTime @map("event_time")
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  shipment    Shipment   @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  admin       AdminUser? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([shipmentId])
  @@index([eventTime])
  @@map("tracking_events")
}

// Shipment Location Model - Real-time GPS stream
model ShipmentLocation {
  id         String   @id @default(uuid())
  shipmentId String   @map("shipment_id")
  latitude   Float
  longitude  Float
  speed      Float?   @default(0)
  heading    Float?   @default(0)
  recordedAt DateTime @default(now()) @map("recorded_at")

  // Relations
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, recordedAt])
  @@map("shipment_locations")
}

// Shipment Movement State - Admin control for pause/resume/intercept
model ShipmentMovementState {
  id              String    @id @default(uuid())
  shipmentId      String    @unique @map("shipment_id")
  isMoving        Boolean   @default(true) @map("is_moving")
  pausedBy        String?   @map("paused_by")
  pausedAt        DateTime? @map("paused_at")
  resumedAt       DateTime? @map("resumed_at")
  interceptReason String?   @map("intercept_reason")
  clearReason     String?   @map("clear_reason")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  shipment   Shipment   @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  pausedByAdmin AdminUser? @relation("PausedBy", fields: [pausedBy], references: [id], onDelete: SetNull)

  @@map("shipment_movement_states")
}

// Address Change Fee Model - Records fees for destination changes
model AddressChangeFee {
  id                  String   @id @default(uuid())
  shipmentId          String   @map("shipment_id")
  previousDestination String   @map("previous_destination")
  newDestination      String   @map("new_destination")
  distanceDifference  Float    @map("distance_difference")
  timeDifference      Float    @map("time_difference")
  baseFee             Float    @default(5.00) @map("base_fee")
  perMileFee          Float    @default(0.50) @map("per_mile_fee")
  totalFee            Float    @map("total_fee")
  appliedAt           DateTime @default(now()) @map("applied_at")
  appliedBy           String?  @map("applied_by")

  // Relations
  shipment            Shipment   @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  admin               AdminUser? @relation(fields: [appliedBy], references: [id], onDelete: SetNull)

  @@index([shipmentId])
  @@map("address_change_fees")
}

// Enums
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  CANCELLED
}

// Support Chat Enums
enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum ConversationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SenderType {
  USER
  ADMIN
  SYSTEM
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}
